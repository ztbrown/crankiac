# Testing: Transcript Speaker Updates

This document summarizes the test coverage for the PATCH `/api/transcripts/segments/speaker` endpoint.

## Test Summary

### Test Coverage Overview

| Test Type | Count | Status | Location |
|-----------|-------|--------|----------|
| Unit Tests | 11 | âœ… Passing | `tests/unit/test_api.py` |
| Integration Tests | 3 | â­ï¸ Skipped (requires database) | `tests/integration/test_transcript_speaker_update.py` |
| End-to-End Test | 1 | â­ï¸ Skipped (requires database) | `tests/acceptance/test_e2e.py` |
| **Total** | **15** | | |

### Running Tests

#### Unit Tests (No Database Required)

Run all unit tests for speaker updates:

```bash
python3 -m pytest tests/unit/test_api.py -k "update_segment_speakers" -v
```

These tests use mocks and don't require a database.

#### Integration Tests (Requires PostgreSQL)

Setup:
```bash
# Create test database
createdb crankiac_test

# Set environment variable
export TEST_DATABASE_URL="postgresql://localhost:5432/crankiac_test"

# Run migrations
DATABASE_URL="$TEST_DATABASE_URL" python -m app.db.migrations
```

Run integration tests:
```bash
python3 -m pytest tests/integration/test_transcript_speaker_update.py -v
```

#### End-to-End Test (Requires PostgreSQL)

```bash
export TEST_DATABASE_URL="postgresql://localhost:5432/crankiac_test"
python3 -m pytest tests/acceptance/test_e2e.py::test_update_segment_speakers_e2e -v
```

## Test Details

### Unit Tests (11 tests)

Located in `tests/unit/test_api.py`:

1. âœ… `test_update_segment_speakers_missing_updates_field` - Validates missing `updates` field
2. âœ… `test_update_segment_speakers_updates_not_array` - Validates `updates` must be array
3. âœ… `test_update_segment_speakers_empty_array` - Validates non-empty array required
4. âœ… `test_update_segment_speakers_missing_id` - Validates `id` field required
5. âœ… `test_update_segment_speakers_missing_speaker` - Validates `speaker` field required
6. âœ… `test_update_segment_speakers_invalid_id_type` - Validates `id` must be integer
7. âœ… `test_update_segment_speakers_invalid_speaker_type` - Validates `speaker` must be string
8. âœ… `test_update_segment_speakers_success` - Tests successful update of 2 segments
9. âœ… `test_update_segment_speakers_partial_success` - Tests partial updates (1 of 2 succeed)
10. âœ… `test_update_segment_speakers_no_json_body` - Validates JSON body required
11. âœ… `test_update_segment_speakers_update_not_object` - Validates update items must be objects

### Integration Tests (3 tests)

Located in `tests/integration/test_transcript_speaker_update.py`:

1. â­ï¸ `test_update_segment_speakers_integration` - Full stack test:
   - Creates test episode and transcript segments
   - Updates speakers via PATCH endpoint
   - Verifies updates persisted to database
   - Cleans up test data

2. â­ï¸ `test_update_segment_speakers_partial_update` - Partial update test:
   - Tests updating mix of existing and non-existing segment IDs
   - Verifies correct counts returned
   - Verifies existing segments updated correctly

3. â­ï¸ `test_update_segment_speakers_validation_errors` - Validation test:
   - Tests all validation error cases
   - Verifies proper error messages returned
   - No database modifications

### End-to-End Test (1 test)

Located in `tests/acceptance/test_e2e.py`:

1. â­ï¸ `test_update_segment_speakers_e2e` - Complete system test:
   - Starts Flask server in background thread
   - Creates test data in database
   - Makes real HTTP PATCH requests
   - Verifies data persisted correctly
   - Verifies data retrievable via search API (GET /api/transcripts/search)
   - Verifies data retrievable via speaker search (GET /api/transcripts/search/speaker)
   - Cleans up test data

## Implementation Details

### Endpoint: PATCH `/api/transcripts/segments/speaker`

**Request Format:**
```json
{
  "updates": [
    {"id": 123, "speaker": "Matt"},
    {"id": 124, "speaker": "Will"}
  ]
}
```

**Response Format:**
```json
{
  "updated": 2,
  "requested": 2
}
```

### Test Data

Integration and E2E tests create temporary test episodes with the following characteristics:

- Episode ID: Generated by database
- Patreon ID: `"test-integration-001"` or `"test-e2e-speaker-update"`
- Title: `"Integration Test Episode"` or `"E2E Test Episode"`
- Transcript segments: 4-6 segments with initial speakers `SPEAKER_00` and `SPEAKER_01`

All test data is automatically cleaned up after each test run.

## Related Documentation

- [Transcript Editor Implementation Plan](docs/transcript-editor-plan.md)
- [Integration Tests README](tests/integration/README.md)
- [API Documentation](README.md)

## Continuous Integration

To run these tests in CI/CD:

1. Set up PostgreSQL service
2. Create test database and run migrations
3. Set `TEST_DATABASE_URL` environment variable
4. Run tests with appropriate markers:
   - Unit: `pytest -m unit`
   - Integration: `pytest -m integration`
   - Acceptance: `pytest -m acceptance`

Example GitHub Actions configuration:

```yaml
services:
  postgres:
    image: postgres:15
    env:
      POSTGRES_DB: crankiac_test
      POSTGRES_PASSWORD: postgres

steps:
  - name: Run migrations
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/crankiac_test
    run: python -m app.db.migrations

  - name: Run tests
    env:
      TEST_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/crankiac_test
    run: |
      pytest tests/unit/ -v
      pytest tests/integration/ -v
      pytest tests/acceptance/ -v
```

## Status Summary

âœ… **Implementation Complete:**
- PATCH endpoint implemented and working
- Storage layer methods implemented
- Comprehensive unit test coverage (11 tests, all passing)

âœ… **Integration Tests Complete:**
- 3 integration tests written
- 1 end-to-end test written
- Documentation complete
- Tests skip gracefully when database not available

ğŸ¯ **Next Steps:**
- Set up CI/CD with PostgreSQL service
- Run integration tests in CI pipeline
- Consider adding performance tests for bulk updates
